<p align="center">
    <img width="200px;" src="https://raw.githubusercontent.com/woowacourse/atdd-subway-admin-frontend/master/images/main_logo.png"/>
</p>
<p align="center">
  <img alt="npm" src="https://img.shields.io/badge/npm-%3E%3D%205.5.0-blue">
  <img alt="node" src="https://img.shields.io/badge/node-%3E%3D%209.3.0-blue">
  <a href="https://edu.nextstep.camp/c/R89PYi5H" alt="nextstep atdd">
    <img alt="Website" src="https://img.shields.io/website?url=https%3A%2F%2Fedu.nextstep.camp%2Fc%2FR89PYi5H">
  </a>
  <img alt="GitHub" src="https://img.shields.io/github/license/next-step/atdd-subway-service">
</p>

<br>

# 인프라공방 샘플 서비스 - 지하철 노선도

<br>

## 🚀 Getting Started

### Install

#### npm 설치

```
cd frontend
npm install
```

> `frontend` 디렉토리에서 수행해야 합니다.

### Usage

#### webpack server 구동

```
npm run dev
```

#### application 구동

```
./gradlew clean build
```

<br>

## 미션

* 미션 진행 후에 아래 질문의 답을 작성하여 PR을 보내주세요.

# 1단계 - 화면 응답 개선하기

## 성능 개선 결과를 공유해주세요 (Smoke, Load, Stress 테스트 결과)

Akamai 조사 결과에 따르면 웹 페이지 로딩 시

`1s 지연 시` `18.4%의 고객 이탈률`을 보이고,

`2s 지연 시` `62.1%의 고객 이탈률`을 보인다고 합니다

따라서 이번 성능 개선은 `1s 이내의 지연시간을 목표`로 진행하였습니다

성능 테스트 전제 조건은 다음과 같습니다.

| 부하 테스트 종류          | VU (명) | 부하 유지기간 (s) | ramp-up 기간 (s) | ramp-down 기간(s) | threshold (ms) |
|:-------------------|:------:|:-----------:|:--------------:|:---------------:|:--------------:|
| smoke              |   2    |     30      |       5        |        5        |      1000      |
| load               |  185   |     60      |       5        |        5        |      1000      |
| stress             |  275   |     60      |       5        |        5        |      1000      |

응답 시간에 대한 `기존 서비스 테스트 결과`는 다음과 같습니다.

| 부하 테스트 종류                | 응답 시간 (s) | WEB - cpu 사용률 (%) | WAS - cpu 사용률 (%) | 에러 발생 시작 VU 수 (명) |
|:-------------------------|:---------:|:-----------------:|:-----------------:|:-----------------:|
| 메인 페이지 - smoke           |   0.05    |        50         |        10         |       none        |
| 메인 페이지 - load            |    0.3    |        80         |        16         |       none        |
| 메인 페이지 - stress          |    0.4    |        90         |        16         |        275        |
| 경로 조회 페이지 - smoke        |    0.1    |        0.4        |        60         |       none        |
| 경로 조회 페이지 - load         |     8     |        10         |        70         |       none        |
| 경로 조회 페이지 - stress (250) |    12     |        30         |        70         |        250        |
| 경로 조회 페이지 - stress (max) |    40     |        100        |        70         |        250        |

테스트의 결과 채택한 개선 사항은 다음과 같습니다

* WEB - TLS, HTTP/2 적용
* WAS - Thread poll size 조정 (default 0 -> 3) + Redis Cache 사용

개선 사항을 적용한 후 테스트 결과입니다 

| 부하 테스트 종류                | 응답 시간 (s) | WEB - cpu 사용률 (%)  | WAS - cpu 사용률 (%) | 에러 발생 시작 VU 수 (명) |
|:-------------------------|:---------:|:------------------:|:-----------------:|:-----------------:|
| 메인 페이지 - smoke           |   0.003   |         50         |        10         |       none        |
| 메인 페이지 - load            |   0.018   |        100         |        10         |       none        |
| 메인 페이지 - stress          |   0.25    |        100         |        30         |  275 (매우 낮은 빈도)   |
| 경로 조회 페이지 - smoke        |   0.004   |         35         |      40 ~ 25      |       none        |
| 경로 조회 페이지 - load         |    0.1    |        100         |      95 ~ 25      |       none        |
| 경로 조회 페이지 - stress (250) |   0.15    |        100         |      95 ~ 25      |        275        |
| 경로 조회 페이지 - stress (max) |    0.2    |        100         |      95 ~ 25      |   275 (6% 실패율)    |

### 결론
* 목표했던 1s의 응답값을 훨씬 밑도는 결과물을 얻었습니다
* `메인 페이지` `stress` 테스트 응답시간이 30% 이상 개선되었습니다
* `WAS` 자원을 많이 사용하는 `경로 조회 페이지 테스트` 의 경우 기존 테스트 대비 정량적으로 측정하기도 어려울 정도의 개선 효과를 얻었습니다
  * `WEB` `WAS` 둘 다 시스템 자원을 최대치로 활용이 가능해졌고, 에러가 발생하기 시작하는 빈도 또한 10% 정도의 개선이 있었습니다
* Redis Cache 적용의 효과가 컸는데, 이는 실제 운영환경에선 또 다른 결과를 얻을 수 있다고 생각합니다. 
  * 하지만 지금 얻어낸 결과물에서 크게 벗어나는 (약 3배 정도 추정) 응답 시간을 받는다고 해도 목표했던 1s에는 미치지 못해 이번 개선은 성공했다고 표현하고 싶습니다
* 또한 현재 WEB의 cpu 사용률이 최대치이고, 발생 되는 에러가 주로 TCP 에러임을 감안한다면, stress 테스트 이상의 트래픽이 들어온다면 WEB 쪽 Scale out을 검토해 볼 수 있을 것 같습니다.


## 어떤 부분을 개선해보셨나요? 과정을 설명해주세요

성능 개선 이전에 성능 개선이 이루어질 수 있는 포인트를 두가지로 분리하였습니다

1. WEB
2. WAS

먼저 `WEB 쪽 성능 개선 테스트는`

1. gzip 압축 적용
2. Cache 적용
3. TLS , HTTP/2 적용

세 가지를 각각 테스트 진행하였으며
WEB 성능 테스트를 위해 `로딩 되는 컨텐츠가 제일 많고`,
`WAS의 리소스 이용률이 제일 적으며` 고객이 가장 `처음 접하는 페이지`로 `TTI` 에 민감한 `메인 페이지` 로딩을 중점적으로 테스트 하였습니다

`Web - gzip 압축 적용`

| 부하 테스트 종류                | 응답 시간 (s) | WEB - cpu 사용률 (%) | WAS - cpu 사용률 (%) | 에러 발생 시작 VU 수 (명) |
|:-------------------------|:---------:|:-----------------:|:-----------------:|:-----------------:|
| 메인 페이지 - smoke           |   0.05    |        45         |         8         |       none        |
| 메인 페이지 - load            |    0.3    |        75         |        13         |       none        |
| 메인 페이지 - stress          |    0.4    |        80         |        13         |        275        |
| 경로 조회 페이지 - smoke        |     1     |         1         |        60         |       none        |
| 경로 조회 페이지 - load         |    28     |         2         |        70         |       none        |
| 경로 조회 페이지 - stress (250) |    35     |         2         |        70         |        250        |
| 경로 조회 페이지 - stress (max) |    40     |        100        |        70         |        250        |

`Web - cache 적용`

전체 캐시의 최대 크기 = 200MB
http status가 200일 경우 20분간 캐싱
만료 기간은 한달

| 부하 테스트 종류                 | 응답 시간 (s) | WEB - cpu 사용률 (%) | WAS - cpu 사용률 (%) | 에러 발생 시작 VU 수 (명) |
|:--------------------------|:---------:|:-----------------:|:-----------------:|:-----------------:|
| 메인 페이지 - smoke            |   0.03    |        50         |      8 ~ 12       |       none        |
| 메인 페이지 - load             |    0.2    |        90         |        13         |       none        |
| 메인 페이지 - stress           |    0.3    |        90         |        13         |        275        |
| 경로 조회 페이지 - smoke         |    0.6    |        0.2        |        55         |       none        |
| 경로 조회 페이지 - load          |    30     |        0.2        |        55         |       none        |
| 경로 조회 페이지 - stress (250)  |    35     |        0.4        |        55         |        250        |
| 경로 조회 페이지 - stress (max)  |    40     |        100        |        55         |        250        |

`Web - TLS, HTTP/2 적용`

| 부하 테스트 종류                 | 응답 시간 (s) | WEB - cpu 사용률 (%) | WAS - cpu 사용률 (%) | 에러 발생 시작 VU 수 (명) |
|:--------------------------|:---------:|:-----------------:|:-----------------:|:-----------------:|
| 메인 페이지 - smoke            |   0.05    |        50         |        10         |       none        |
| 메인 페이지 - load             |    0.2    |      80 ~ 70      |        13         |       none        |
| 메인 페이지 - stress           |    0.3    |     100 ~ 70      |        13         | 275 (생각보다 적은 빈도)  |
| 경로 조회 페이지 - smoke         |    0.7    |         4         |        55         |       none        |
| 경로 조회 페이지 - load          |    30     |         4         |        55         |       none        |
| 경로 조회 페이지 - stress (250)  |    35     |        0.4        |        55         |       none        |
| 경로 조회 페이지 - stress (max)  |    38     |        100        |        55         |        275        |

WAS 쪽 테스트 내용의 특이사항은 다음과 같습니다

1. 전체적으로 WAS쪽 자원을 많이 사용하는 `경로 조회 페이지`의 경우 `WAS` 어플리케이션 레벨에서 이미 지연이 발생하고 있기에 유의미한 데이터를 얻기 힘듭니다
2. 반면에 `메인 페이지` 테스트 결과 중 얻을 수 있는 특징은 `WEB spu 사용률`입니다
    * `gzip 압축`은 트래픽이 증가함에 따라 cpu 사용률이 동시에 증가합니다
    * `cache`의 경우 메인 페이지 테스트에서 전체적으로 높은 cpu 사용률을 보여줬지만, 경로 조회 테스트에서 상대적으로 적은 cpu 사용률이 눈에 띕니다
    * `TLS, HTTP/2`의 경우 멀티플랙싱으로 초기 connection에 필요한 리소스 때문에 초반 높은 cpu 사용률을 나타내지만, 커넥션이 안정화되면서 점점 낮아지는 cpu 사용률을 보여줍니다

다음은 `WAS 성능 개선 테스트`로

1. Redis Cache 적용
2. Thread pool size 조정 + Async

를 진행하였습니다.
Thread pool size 조정은 현재 서버 core 수(2) * 1.5 = 3개의 thread로 계산하여 적용하였습니다

테스트 결과는 다음과 같습니다

`WAS - Redis Cache 적용`

| 부하 테스트 종류                 | 응답 시간 (s) | WEB - cpu 사용률 (%) | WAS - cpu 사용률 (%) | 에러 발생 시작 VU 수 (명) |
|:--------------------------|:---------:|:-----------------:|:-----------------:|:-----------------:|
| 경로 조회 페이지 - smoke         |   0.004   |        40         |        35         |       none        |
| 경로 조회 페이지 - load          |   0.06    |        100        |        70         |       none        |
| 경로 조회 페이지 - stress (250)  |   0.08    |        100        |        70         |       none        |
| 경로 조회 페이지 - stress (max)  |   0.08    |        100        |        70         |    275 (적은 빈도)    |

`WAS - Thread poll size 조정` (default 0 -> 3) + async

| 부하 테스트 종류                | 응답 시간 (s) | WEB - cpu 사용률 (%) | WAS - cpu 사용률 (%) |      에러 발생 시작 VU 수 (명)      |
|:-------------------------|:---------:|:-----------------:|:-----------------:|:---------------------------:|
| 경로 조회 페이지 - smoke        |   0.005   |        30         |        95         |            none             |
| 경로 조회 페이지 - load         |   0.16    |        70         |        97         |            none             |
| 경로 조회 페이지 - stress (250) |   0.16    |        100        |        97         |       250 (많은 빈도 tcp)       |
| 경로 조회 페이지 - stress (max) |   0.18    |        100        |        97         |       250(많은 빈도 tcp)        |

캐시와 쓰레드의 힘은 대단.. 했습니다

* 서버의 `cpu 사용률`을 개선 전에 비해 `끌어 올리고`
* `WEB` 쪽 `cpu 사용률`이 `최대치`로 올라온 것을 보면, 기존 서비스의 `WAS 쪽 병목 현상`이 어느정도 `해소`된 것도 파악할 수 있습니다
* `Redis Cache`의 경우 stress 테스트 vu 최대 값에서도 `에러율이 상당히 낮았던 점`이 인상 깊었습니다
* 결과적으로 응답시간도 목표했던 `2s를 훨씬 밑도는 결과`를 얻었습니다

---

### 2단계 - 스케일 아웃

1. Launch Template 링크를 공유해주세요.

2. cpu 부하 실행 후 EC2 추가생성 결과를 공유해주세요. (Cloudwatch 캡쳐)

```sh
$ stress -c 2
```

3. 성능 개선 결과를 공유해주세요 (Smoke, Load, Stress 테스트 결과)

---

### 3단계 - 쿼리 최적화

1. 인덱스 설정을 추가하지 않고 아래 요구사항에 대해 1s 이하(M1의 경우 2s)로 반환하도록 쿼리를 작성하세요.

- 활동중인(Active) 부서의 현재 부서관리자 중 연봉 상위 5위안에 드는 사람들이 최근에 각 지역별로 언제 퇴실했는지 조회해보세요. (사원번호, 이름, 연봉, 직급명, 지역, 입출입구분, 입출입시간)

---

### 4단계 - 인덱스 설계

1. 인덱스 적용해보기 실습을 진행해본 과정을 공유해주세요

---

### 추가 미션

1. 페이징 쿼리를 적용한 API endpoint를 알려주세요
